---
title: "White Wine Exploration"
author: "Aden Guo"
date: "2016/01/11"
output: html_document
---

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
library(ggplot2)
library(reshape)
library(gridExtra)
library(GGally)
library(dplyr)
library(knitr)
library(rgl)
library(rglwidget)
knit_hooks$set(webgl = hook_webgl)
```

```{r echo=FALSE, Load_the_Data}
white_wine <- read.csv("../wineQualityWhites.csv")
```

## **Introduction**
The data which will be analysed contains physicochemical sensory information of white wine of Vinho Verde. Vinde Verde, meaning "green wine", is produced in Minho area located at northwest Portugal. The word "green" indicates the wine's young age and not its color. The most important feature of the wine is its youth and freshness. And it should be consumed soon after bottling.

<a style='text-decoration: none;'>
  <img src="pics/White_Vinho_Verde_1.jpg" style='width: 500px'>
  <div style='width: 500px; text-align: center;'> White Vinho Verde </div>
</a>

Vinho Verde could be white, red or rose. And the most productive kind of Vinho Verde is white. The dataset explored here includes 11 important laboratory tested physicochemical values of the wine and one sensory test result from human expert. 

Next several sections will explored some important patterns and correlations of these data items. These exploration will focused on the question: what makes Vinho Verde taste good?

### Summaries of data

Number of items of the data.
```{r}
nrow(white_wine)
```
Features of the data. In all the variables,  X is item number. From fixed.acidity to alcohol is the quantitative values of physicochemical tests. And the last variable, quality, is the subjective grades given by human. It takes values from 1(very bad) to 10(excellent).   
```{r}
str(white_wine)
```
Summary of the physicochemical results in the dataset. All these variables are numerical. As showed in this chart. Values of some variables are very stable and some have diverse distribution. For example, all the density is very similar and residual sugar are range from 0.6 - 65.800. And some variables tell some facts about the wine. pH is all below 4 suggest that the wine contains acid. And the very different kind of sugar level suggest some wine taste very sweet(sweetness may be from fruit). 
```{r}
summary(white_wine[,2:12])
```

## **Univariate Analysis**
The most important variable is quality. All the other values about chemical composition are for high quality. So in this section, the quality of all the values are analyzed.

Since the quality of the wine is defined in ten grades which are from human experts. The grades of wine in this data are ordinal level factors. From the numbers of each grades and the bar plot of the grades, Although there are total 10 grades (1-10) of the quality. No wine was identify as grade 1, 2, 10.  This result means that no human expert gave one of the 4898 white wine of Vinho Verde very bad grades or perfect scores. No very bad grades may be explained by the fact that all the Vindo Verde are produced in the same area and under similar condition. And lacking of excellent quality (noticed that even grade 9 is very rare in almost 5000 kinds of white wine) may be the result of the marketing of Vinho Verde. Vinho Verde is regard as inexpensive and fun. The wine is not usually treated as serious and high-end wine. I believe this may result in human experts' unwillingness to grand very high grades to this kind of wine.        
```{r}
white_wine$ordered_quality <- factor(white_wine$quality, levels=c("1", "2", "3","4","5","6","7","8","9","10"), ordered = TRUE)
table(white_wine$ordered_quality)
ggplot(data = white_wine, aes(x = ordered_quality)) +
 geom_bar(aes(fill = ordered_quality))
```

Following is the pie chart of the qualities of wines. Grade 5, 6, 7 occupy most kinds of Vinho Verde. The number of wines which is graded below 5 or above 7 is very small compare to middle grades. 
```{r}
ggplot(data = white_wine, aes(x = factor(1), fill = ordered_quality)) +
 geom_bar(width = 1) + 
 coord_polar(theta = "y")
```

Above features of the variable quality suggest that the grades of Vinho Verde are very concentrated. Based on these observations, I divided the wines into three categories by the high drops of numbers of wines from grade 5 to 4 and from 7 to 8. I name these three categories "low"(grade 3 and 4), "normal"(grade 5, 6 and 7) and "high"(grade 8 and 9). It can be seen from the table and the pir chart of the distribution of three categories. low and high almost contain the same number of wines and most wines have quality normal. 
```{r}
white_wine$ordered_category <- white_wine$ordered_quality
levels(white_wine$ordered_category) <- c("low", "low", "low","low","normal","normal","normal","high","high","high")
table(white_wine$ordered_category)
ggplot(data = white_wine, aes(x = factor(1), fill = ordered_category)) +
 geom_bar(width = 1) + 
 coord_polar(theta = "y")
```

From above univariate analysis, the following analysis will be on two levels, categories and sub-categories. Analysis of categories is aiming to distinguish low, normal and high quality of Vinho Verde wines. And analysis of sub-categories is to identify differences of grades in the same category. The main content is to find differences between grade 5, 6 and 7 in normal quality. 

## **Bivariate Analysis**
 First comparison of normalized 11 physicochemical variables. Some variables have many outliers( chlorides and volatile.acidity) and some few outliers( alcohol and density).  It is also interesting to see the patterns of the outliers. Some outliers are distributed in a broad range. These outliers are from variable chlorides, volatile.acidity and free.sulfur.dioxide. Some outliers are centered around a relative small range. These outliers are from variable pH, sulphates and fixed.acidity. The broad range of outliers may indicate different levels of some chemical substances which occures in many measurements of chemical experiment. The clustered outliers can give more informative story about the chemical composition in the wines. The thoery is that majority of white Vinho Verde show a normal level of certain chemical feature. And there are minority of  white Vinho Verde whose level of that chemical feature behave in a different way.  
 
```{r message=FALSE, warning=FALSE, fig.height = 10, fig.width=15}
ggplot(melt(as.data.frame(scale(white_wine[,2:12]))),aes(x = variable,y = value)) + geom_boxplot()+scale_y_continuous(limits = c(-2,15))
```

Let us begin with these features whose outliers clustered together. They are pH, sulphates and fixed.acidity. From the following figures, different quality of categories may have the different pH. And the difference of the other two variables is not as obvious as that of pH. The values of pH confirms the thoery mentioned before. Some high pH value wine is clustered and most wine has lower pH value. Furthermore wine with high pH value belong to high quality category. There is another subtle observation need to be examined in a further step. For variable fixed.acidity there is a little peak in front of density line of high quality. This could mean different sub levels in high quality.   

```{r fig.height = 10, fig.width=15}
p_ph_1 = ggplot(data = white_wine, aes(x = ordered_category, y = pH)) + geom_boxplot()
p_ph_2 = ggplot(data = white_wine, aes(pH, fill = ordered_category)) + geom_density(alpha = 0.2)
p_sulphates_1 = ggplot(data = white_wine, aes(x = ordered_category, y = sulphates)) + geom_boxplot()
p_sulphates_2 = ggplot(data = white_wine, aes(sulphates, fill = ordered_category)) + geom_density(alpha = 0.2)
p_fixed_acidity_1 = ggplot(data = white_wine, aes(x = ordered_category, y = fixed.acidity)) + geom_boxplot()
p_fixed_acidity_2 = ggplot(data = white_wine, aes(fixed.acidity, fill = ordered_category)) + geom_density(alpha = 0.2)
grid.arrange(p_ph_1, p_ph_2, p_sulphates_1, p_sulphates_2, p_fixed_acidity_1,  p_fixed_acidity_2, nrow=3, ncol = 2)
```

Sub-categories boxp[lot] of ph and fixed.acidity is as following. As the boxplot reveals. The grades of wines veries with pH. And the highest grade of the wine(grade 9) has more fixed acidity in it. However, the analysis of any data related to grade 9 should carefully carried out. Since there are only 5 wines are rated 9. 
```{r fig.height = 10, fig.width=15}
p_ph_1 = ggplot(data = white_wine, aes(x = ordered_quality, y = pH)) + geom_boxplot()
p_fixed_acidity_1 = ggplot(data = white_wine, aes(x = ordered_quality, y = fixed.acidity)) + geom_boxplot()
grid.arrange(p_ph_1, p_fixed_acidity_1, nrow=2, ncol = 1)
```

The remaining 8 variables are also analyzed. The density plot is as following. To discriminate low quality with other quality, the variable free.sulfur.dioxide make sense. And the differences of high quality and other quality can be seen from variable chlorides, density and alcohol. 

```{r fig.height = 20, fig.width=15}
p_volatile.acidity = ggplot(data = white_wine, aes(volatile.acidity, ..density.., colour = ordered_category)) + geom_density()
p_citric.acid = ggplot(data = white_wine, aes(citric.acid, ..density.., colour = ordered_category)) + geom_density()
p_residual.sugar = ggplot(data = white_wine, aes(residual.sugar, ..density.., colour = ordered_category)) + geom_density()
p_chlorides = ggplot(data = white_wine, aes(chlorides, ..density.., colour = ordered_category)) + geom_density()
p_free.sulfur.dioxide = ggplot(data = white_wine, aes(free.sulfur.dioxide, ..density.., colour = ordered_category)) + geom_density()
p_total.sulfur.dioxide = ggplot(data = white_wine, aes(total.sulfur.dioxide, ..density.., colour = ordered_category)) + geom_density()
p_density = ggplot(data = white_wine, aes(density, ..density.., colour = ordered_category)) + geom_density()
p_alcohol = ggplot(data = white_wine, aes(alcohol, ..density.., colour = ordered_category)) + geom_density()
grid.arrange(p_volatile.acidity, p_citric.acid, p_residual.sugar, p_chlorides, p_free.sulfur.dioxide,  p_total.sulfur.dioxide, p_density, p_alcohol, nrow=8)
```

In the bivariate analysis, several variables are identified to be useful in analysis of wine quality. These variables are pH, free.sulfur.dioxide, chlorides, density and alcohol. Following analysis will concentrate on relationship of these variables and wine quality.

## **Multivariate Analysis**

The paired draw of these variables shows some interesting properties besides their relations with wine quality as mentioned in last chapter. The first one is the correlation of variables. It can be seen from picture that a linear correlation exists in variable density and alcohol. Wines having high alcohol tend to have low density. Similar but not apparent relation exists in variable alcohol and chlorides. The correlations between these variables indicate that these variable may contribute to the wine quality in the same manner. 
```{r message=FALSE, warning=FALSE, fig.height = 15, fig.width=15}
var_names <- c("pH", "free.sulfur.dioxide", "chlorides", "density", "alcohol", "ordered_quality", "ordered_category")
white_wine_subset = newdata <- white_wine[var_names]
ggpairs(white_wine_subset)
```

The next plot shows some relations between wine quality and variables pH and alcohol. Due to large number of normal quality, the visualization is not definitely clear. Howewver, we can still show some variations of pH and alcohol according to different categories of wines. First, the high quality wines tend to have high alcohol value and low quality wines low alcohol value. Second, it is very hard to tell any difference of pH of low and normal quality and the pH of high quality is slightly bigger than that of other two qualities of wine.    
```{r fig.height = 10, fig.width=10}
ggplot(data = white_wine_subset, aes(alcohol, pH)) + geom_point(aes(size = ordered_category, colour = ordered_category, shape = ordered_category), alpha = 0.7)
```

The following figure can help to identify the difference of low and other two quality of wine by looking at the variable free.sulfur.dioxide. It is obvious that most low quality wine have low value of free.sulfur.dioxide. And high quality wine also have slightly high value of free.sulfur.dioxide. There are another observation need to be pointed out which is that the variation of free.sulfur.dioxide is more high than that of the other two qualities of wine. The most low quality wine of have relativey low free.sulfur.dioxide. But several low quality wine have the highest free.sulfur.dioxide in the whole collection of Vinho Verde wines. 
```{r fig.height = 5, fig.width=10}
ggplot(data = white_wine_subset, aes(alcohol, free.sulfur.dioxide)) + geom_point(aes(size = ordered_category, colour = ordered_category, shape = ordered_category), alpha = 0.7)
```

Another similar plot can be draw between wine quality and variable chlorides and density. Many high quality wine are located at left lower corner of the plot. The values of density and chlorides of high quality wine is lower than that of the other two qualities of wine. The two values of low quality wine don't stand out from the whole collection of wine. 
```{r fig.height = 5, fig.width=10}
ggplot(data = white_wine_subset, aes(chlorides, density)) + geom_point(aes(size = ordered_category, colour = ordered_category, shape = ordered_category), alpha = 0.5)
```

Further exploration of data is needed to clarify the above relations. The difficulties arise from the unbalanced number of normal quality wines and the other two categories of wine. The way I addressed this problem is by ratios. Since most of wines are in normal quality. I will compare the ratio of low or high quality wines to normal quality wines in the different intelvals of various variables. 
```{r}
ratio_data_category <- function(data_frame, variable, breaks_number) {
  data_frame$variable_bucket <- cut(variable, breaks = breaks_number,  labels = FALSE, ordered_result = TRUE)
  group_data <- group_by(data_frame, ordered_category, variable_bucket)
  summarised_data <- summarise(group_data, n = n())
  intervel_levels <- unique(summarised_data$variable_bucket)
  low_ratio = c()
  high_ratio = c()
  normal_number = c()
  levels_number = c()
  for (level in intervel_levels){
    normal_level_count <- subset(summarised_data, summarised_data$variable_bucket == level & summarised_data$ordered_category == 'normal' )
    low_level_count <- subset(summarised_data, summarised_data$variable_bucket == level & summarised_data$ordered_category == 'low' )
    high_level_count <- subset(summarised_data, summarised_data$variable_bucket == level & summarised_data$ordered_category == 'high')
    if (nrow(normal_level_count) > 0){
      normal_level_count <- normal_level_count$n
    }else{
      normal_level_count <- 1
    }
    if (nrow(low_level_count) > 0){
      low_level_count <- low_level_count$n
    }else{
      low_level_count <- 0
    }
    if (nrow(high_level_count) > 0){
      high_level_count <- high_level_count$n
    }else{
      high_level_count <- 0
    }
    low_ratio <- c(low_ratio, low_level_count/normal_level_count)
    high_ratio <- c(high_ratio, high_level_count/normal_level_count)
  }
  final_data <- data.frame(variale_intervel = intervel_levels, low_ratio = low_ratio, high_ratio = high_ratio)
  return(final_data)
}

pH_ratio <- ratio_data_category(white_wine_subset, white_wine_subset$pH, 8)
ggplot(pH_ratio, aes(x = variale_intervel)) + 
          geom_smooth(aes(y = high_ratio, colour = "high quality ratio"), se = FALSE) + 
          geom_smooth(aes(y = low_ratio, colour = "low quality ratio"), se = FALSE) +
          scale_colour_manual("quality ratio", 
                      values = c("high quality ratio" = "red", "low quality ratio" = "blue")) 

```

```{r}
white_wine_subset_remove <- subset(white_wine_subset, white_wine_subset$free.sulfur.dioxide < quantile(white_wine_subset$free.sulfur.dioxide, 0.95))
free.sulfur.dioxide_ratio <- ratio_data_category(white_wine_subset_remove, white_wine_subset_remove$free.sulfur.dioxide, 10)
ggplot(free.sulfur.dioxide_ratio, aes(x = variale_intervel)) + 
          geom_smooth(aes(y = high_ratio, colour = "high quality ratio"), se = FALSE) + 
          geom_smooth(aes(y = low_ratio, colour = "low quality ratio"), se = FALSE) +
          scale_colour_manual("quality ratio", 
                      values = c("high quality ratio" = "red", "low quality ratio" = "blue"))

alcohol_ratio <- ratio_data_category(white_wine_subset, white_wine_subset$alcohol, 10)
ggplot(alcohol_ratio, aes(x = variale_intervel)) + 
          geom_smooth(aes(y = high_ratio, colour = "high quality ratio"), se = FALSE) + 
          geom_smooth(aes(y = low_ratio, colour = "low quality ratio"), se = FALSE) +
          scale_colour_manual("quality ratio", 
                      values = c("high quality ratio" = "red", "low quality ratio" = "blue"))

white_wine_subset_remove <- subset(white_wine_subset, white_wine_subset$chlorides < quantile(white_wine_subset$chlorides, 0.95))
chlorides_ratio <- ratio_data_category(white_wine_subset_remove, white_wine_subset_remove$chlorides, 10)
ggplot(chlorides_ratio, aes(x = variale_intervel)) + 
          geom_smooth(aes(y = high_ratio, colour = "high quality ratio"), se = FALSE) + 
          geom_smooth(aes(y = low_ratio, colour = "low quality ratio"), se = FALSE) +
          scale_colour_manual("quality ratio", 
                      values = c("high quality ratio" = "red", "low quality ratio" = "blue"))

```

```{r webgl=TRUE}
example(plot3d)

```

## **Final Plots and Summary**

## **Reflection**


